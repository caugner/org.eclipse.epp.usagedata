<?xml version="1.0" encoding="UTF-8"?>
<project 
  default="createUpdateSite"
  name="Create Update Site">
  
  <target name="createUpdateSite">
    <antcall target="createSiteXML" />
    <antcall target="updateZIP" />
    <antcall target="cleanup" />
  </target>

  <target name="createSiteXML">
    <echo message="Creating site.xml" />
    <copy 
      file="${builder}/templates/site.xml" 
      tofile="${buildDirectory}/${buildLabel}/site.xml" />
    <replace file="${buildDirectory}/${buildLabel}/site.xml" 
      token="XXXXXXXXXXXXX"
      value="${buildLabel}">
    </replace>
  </target>

  <target name="updateZIP">
    <echo message="Update ZIP file" />
    <zip destfile="${buildDirectory}/${buildLabel}/org.eclipse.epp.usagedata.feature-${buildId}.zip"
      update="true">
      <zipfileset 
        dir="${buildDirectory}/${buildLabel}" 
      	includes="site.xml" 
      	fullpath="eclipse/site.xml"/>
  	</zip>
  </target>
  
  <target name="cleanup">
    <echo message="Remove site.xml file" />
    <delete file="${buildDirectory}/${buildLabel}/site.xml" />
  </target>
  
  <target name="populateUpdateSite">
    <echo message="Upload new content to EPP testing update site" />
    <unzip 
      src="${buildDirectory}/${buildLabel}/org.eclipse.epp.usagedata.feature-${buildId}.zip"
      dest="/home/data/httpd/download.eclipse.org/technology/epp/updates/testing/"
      overwrite="true">
      <mapper 
        type="regexp" 
        from="^eclipse/(.*)" 
        to="\1"/>
    </unzip>
  </target>
  
</project>